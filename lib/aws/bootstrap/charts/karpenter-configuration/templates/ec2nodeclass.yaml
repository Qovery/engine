apiVersion: karpenter.k8s.aws/v1
kind: EC2NodeClass
metadata:
  name: default
spec:
  amiSelectorTerms:
    - alias: al2@latest
  role: "KarpenterNodeRole-{{ .Values.clusterName }}"
  subnetSelectorTerms:
    {{- if .Values.explicitSubnetIds }}
    {{- range.Values.explicitSubnetIds }}
    - id: {{ . }}
    {{- end }}
    {{- else }}
    - tags:
        karpenter.sh/discovery: "{{ .Values.clusterName }}"
    {{- end }}
  securityGroupSelectorTerms:
    - id: {{ .Values.securityGroupId }}

  # configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: {{ .Values.diskSizeInGib }}
        volumeType: gp2
        encrypted: true
        deleteOnTermination: true

  # Optional, propagates tags to underlying EC2 resources
  tags:
    {{- range $key, $value := .Values.tags }}
       {{ $key }}: {{ $value }}
    {{- end }}
